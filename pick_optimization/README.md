# Pick Optimization Models: Tour Formation & Tour Allocation

This document provides guidance on how to use the Tour Formation (TF) and Tour Allocation (TA) models within the `pick_optimization` directory.

## Overview

The pick optimization process consists of two main steps:

1.  **Tour Formation (TF):** Generates potential pick tours. It can operate in different modes depending on the desired outcome (run_complete, clustering step, or solving clusters).
2.  **Tour Allocation (TA):** Selects a subset of the generated tours from TF to be released based on a target number of tours.

Utility functions in `platform_utils.py`, provide a bridge between the output of TF and the input required by TA.

## Dependencies

Ensure you have the necessary Python packages installed. You can install them using the `requirements.txt` file:

```bash
pip install -r requirements.txt
```

## 1. Tour Formation (TF)

### Purpose

The TF model creates optimized pick tours. It group containers into clusters and then solves for the optimal tour within each cluster. Clusters can be solved indepedently / in-parallel.

### Entry Point

The main entry point for TF is the `run_tour_formation_entrypoint` function located in `tour_formation/tf_entry.py`.

### Modes of Operation

TF can be run in one of three modes, specified by the `mode` parameter:

*   `run_complete`: Executes the entire process: clustering and solving for tours for all clusters.
*   `generate_clusters`: Performs only the clustering step, saving the cluster assignments and subproblem data to the `working_dir`.
*   `solve_cluster`: Solves the tour formation problem for a single, specified cluster (using the `cluster_id` parameter). Requires prior execution of `generate_clusters`.

### Parameters

The `run_tour_formation_entrypoint` function requires the following parameters (refer to `tf_test.py` for an example):

*   `mode` (str): The desired mode of operation (`'run_complete'`, `'generate_clusters'`, or `'solve_cluster'`).
*   `fc_id` (str): e.g., `'AVP1'`.
*   `planning_timestamp` (datetime): The timestamp associated with the planning run. This influences the input/output/working directory paths for local runs. Can change setup for S3. 
*   `input_dir` (str or Path): Path to the directory containing TF input files.
*   `output_dir` (str or Path): Path where TF output files (final tours, metadata) will be saved.
*   `working_dir` (str or Path): Path for intermediate files, for cluster subproblems when using `generate_clusters` mode.
*   `labor_headcount` (int): The available labor headcount for the planning period, obtained from simulation.
*   `cluster_id` (int, optional): The target cluster ID to solve. Only required when `mode='solve_cluster'`.

### Input/Output/Working Directory Structure

The models expect a specific directory structure based on FC ID and timestamp:

*   **Input:** `pick_optimization/input/{fc_id}/{timestamp_str}/`
    *   *(Input files required by TF go here)*
*   **Output:** `pick_optimization/output/{fc_id}/{timestamp_str}/`
    *   Contains final tour results (`run_complete`), cluster solution (`solve_cluster`), and `clustering_metadata.csv`.
*   **Working:** `pick_optimization/working/{fc_id}/{timestamp_str}/`
    *   Contains intermediate files like cluster subproblems (`generate_clusters`).

Where `{timestamp_str}` is derived from `planning_timestamp` (e.g., `YYYYMMDD_HHMMSS`). The `setup_directories` function in `tf_test.py` demonstrates this creation logic.

### Example Usage

See `tf_test.py` for a runnable example. Configure the constants like `FC_ID`, `PLANNING_TIMESTAMP_STR`, `LABOR_HEADCOUNT`, `MODE`, and `TARGET_CLUSTER_ID` as needed, then execute the script:

```bash
python pick_optimization/tf_test.py
```

## 2. Bridging TF Output to TA Input (`platform_utils.py`)

### Purpose

The TF model, when run completely or cluster by cluster, produces output files *per cluster* (e.g., `cluster_1_container_tours.csv`, `cluster_2_container_tours.csv`, etc.) in its output directory.

The TA model however expects *single, consolidated* input files (e.g., `container_tours.csv`) representing the entire pool of available tours generated by TF.

The `platform_utils.py` script bridges this gap. Run this script to create inputs for TA.

### Functionality

The core function is `create_tour_allocation_inputs`. It performs the following:

1.  Reads the `clustering_metadata.csv` from the TF output directory to know which clusters were processed.
2.  Identifies specific TF output files (like `_container_tours.csv`, `_pick_assignments.csv`, etc.) for each cluster ID found in the metadata.
3.  Reads and concatenates the corresponding files across all clusters.
4.  Writes the consolidated DataFrames into single files within the TA input directory, using the expected TA input filenames (e.g., `container_tours.csv`).

This consolidation effectively creates the pool of candidate tours from which TA will select. This is crucial for managing the tour pool across different model runs or releases.

### Usage

Call the `create_tour_allocation_inputs` function, providing the TF output timestamp and the desired TA input timestamp.

```python
from datetime import datetime
from pick_optimization.platform_utils import create_tour_allocation_inputs

# Example:
fc_id = 'AVP1'
tf_timestamp = datetime.strptime('2025-03-06_140000', '%Y-%m-%d_%H%M%S')
ta_timestamp = datetime.strptime('2025-03-06_140000', '%Y-%m-%d_%H%M%S') # Can be same or different

create_tour_allocation_inputs(
    fc_id=fc_id,
    tf_planning_timestamp=tf_timestamp,
    ta_planning_timestamp=ta_timestamp
)
```

See the `if __name__ == "__main__":` block in `platform_utils.py` for a test example.

## 3. Tour Allocation (TA)

### Purpose

The TA model selects a specified number of tours (`target_tours`) from the consolidated pool of tours generated by TF (and prepared by `platform_utils.py`).

### Entry Point

The main entry point for TA is the `run_tour_allocation_entrypoint` function located in `tour_allocation/ta_entry.py`.

### Parameters

The `run_tour_allocation_entrypoint` function requires the following parameters (refer to `ta_test.py` for an example):

*   `fc_id` (str): The Facility Center ID.
*   `planning_timestamp` (datetime): The timestamp associated with the planning run. This determines the input/output directory paths. **This timestamp should match the `ta_planning_timestamp` used when running `platform_utils.py`**.
*   `input_dir` (Path): Path to the directory containing the consolidated TA input files (created by `platform_utils.py`).
*   `output_dir` (Path): Path where TA output files (selected tours) will be saved.
*   `target_tours` (int): The desired number of tours to select and allocate.
*   `logger` (logging.Logger, optional): An optional logger instance.

### Input/Output Directory Structure

TA uses a similar structure, determined by its `planning_timestamp`:

*   **Input:** `pick_optimization/input/{fc_id}/{timestamp_str}/`
    *   Contains consolidated files like `container_tours.csv`, `pick_assignments.csv`, etc., as prepared by `platform_utils.py`.
*   **Output:** `pick_optimization/output/{fc_id}/{timestamp_str}/`
    *   Contains the final allocation results (the selected tours).

Where `{timestamp_str}` matches the `planning_timestamp` provided to TA (and the `ta_planning_timestamp` used in the utility script). The `setup_directories` function in `ta_test.py` shows this logic.

### Example Usage

See `ta_test.py` for a runnable example. Ensure the input directory for TA (`pick_optimization/input/{fc_id}/{timestamp_str}/`) has been populated by running `platform_utils.py` first. Configure the constants like `FC_ID`, `PLANNING_TIMESTAMP_STR`, and `TARGET_TOURS`, then execute the script:

```bash
python pick_optimization/ta_test.py
```